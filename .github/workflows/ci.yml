name: "CI SYMFONY"

on:
    push:
        paths:
            - src/**
            - "!src/docs/**"
            - .github/workflows/ci.yml
        #paths-ignore:
        #    - src/docs

jobs:
    lint:
        name: "Linting (PHP-CS-Fixer + PHPStan)"
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                php-version: '8.2'
                extensions: mbstring, xml, ctype, iconv, intl, zip
                coverage: none
            
            - name: Install dependencies
              run: composer install --prefer-dist --no-progress

            - name: Download PHP-CS-Fixer
              run: curl -L https://cs.symfony.com/download/php-cs-fixer-v3.phar -o php-cs-fixer

            - name: Run PHP-CS-Fixer
              run: php php-cs-fixer fix --dry-run --diff

            - name: Run PHPStan
              run: vendor/bin/phpstan analyse src tests

    health-test:
        name: "Healthcheck"
        needs: [lint]
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Setup PHP
            uses: shivammathur/setup-php@v2
            with:
              php-version: '8.2'

          - name: Install dependencies
            run: composer install --prefer-dist --no-progress

          - name: Install Symfony CLI
            run: |
              curl -sS https://get.symfony.com/cli/installer | bash
              echo "$HOME/.symfony/bin" >> $GITHUB_PATH

          - name: Start Symfony server
            run: |
              symfony server:start -d --port=8000
              for i in {1..10}; do
                curl -f http://127.0.0.1:8000 && break
                sleep 3
              done

          - name: Health check
            run: curl -f http://127.0.0.1:8000

          - name: Stop server
            run: symfony server:stop  

    unit-tests:
        name: "Tests Unitaires"
        needs: [lint]
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Setup PHP
            uses: shivammathur/setup-php@v2
            with:
              php-version: '8.2'

          - name: Install dependencies
            run: composer install --prefer-dist --no-progress

          - name: Run PHPUnit (Unit Tests)
            run: vendor/bin/phpunit tests/Unit

    integration-tests:
        name: "Tests d'Intégration"
        needs: [unit-tests]
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Setup PHP
            uses: shivammathur/setup-php@v2
            with:
              php-version: '8.2'

          - name: Install dependencies
            run: composer install --prefer-dist --no-progress

          - name: Run PHPUnit (Integration Tests)
            run: vendor/bin/phpunit tests/Integration

    e2e-tests:
        name: "Tests E2E (Cypress)"
        needs: [integration-tests]
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Setup PHP
            uses: shivammathur/setup-php@v2
            with:
              php-version: '8.2'

          - name: Install dependencies
            run: composer install --prefer-dist --no-progress

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '20'

          - name: Install Cypress
            run: npm install cypress --save-dev

          - name: Install Symfony CLI
            run: |
              curl -sS https://get.symfony.com/cli/installer | bash
              echo "$HOME/.symfony/bin" >> $GITHUB_PATH

          - name: Start Symfony server
            run: |
              symfony server:start -d --port=8000
              for i in {1..10}; do
                curl -f http://127.0.0.1:8000 && break
                sleep 3
              done

          - name: Run Cypress
            run: npx cypress run

          - name: Stop server
            run: symfony server:stop

    notify:
        name: "Notification"
        needs:
          - lint
          - health-test
          - unit-tests
          - integration-tests
          - e2e-tests
        runs-on: ubuntu-latest
        if: always()
        steps:
          - name: Check status
            run: |
              if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
                echo "✅ Tous les tests sont passés avec succès !"
              else
                echo "❌ Des tests ont échoué !"
                exit 1
              fi